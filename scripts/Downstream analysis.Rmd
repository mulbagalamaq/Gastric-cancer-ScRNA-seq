---
title: "Gastric Cancer - malignant ascites study"
subtitle: "GSE228598 scRNA-seq Analysis Part 2 - CellChat"
author: "Aymen Maqsood"
date: "2026-02-19"
output:
  html_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = "center")

# Ensure we're in project root whether knitting or running interactively
if (basename(getwd()) == "scripts") setwd("..")
knitr::opts_knit$set(root.dir = getwd())
```

## Setup

```{r load_libraries, warning=FALSE, message=FALSE}

##############################
###        SETUP           ###
##############################

# Loading required libraries
library(Seurat)
library(CellChat)
library(ggplot2)
library(dplyr)
library(patchwork)
set.seed(1)

# Loading merged object with compartment + Azimuth labels from Part 1
merged <- readRDS("data_processed/gse228598_harmony.rds")
```

## Cell Labels for CellChat

CellChat needs discrete groups, so collapsing Azimuth L2 subtypes into broader categories. Immune cells get Azimuth labels, non-immune keep their compartment name.

```{r cell_labels, warning=FALSE, message=FALSE}

##############################
###    CELL LABELS         ###
##############################

# Mapping Azimuth L2 subtypes to CellChat groups
# could do finer resolution here but 10 groups is enough for pathway-level analysis
label_map <- c(
  "CD14 Mono" = "CD14 Mono", "CD16 Mono" = "CD16 Mono",
  "cDC1" = "cDC", "cDC2" = "cDC", "pDC" = "cDC",
  "CD4 CTL" = "CD4 T", "CD4 Naive" = "CD4 T", "CD4 Proliferating" = "CD4 T",
  "CD4 TCM" = "CD4 T", "CD4 TEM" = "CD4 T", "Treg" = "CD4 T",
  "CD8 Naive" = "CD8 T", "CD8 Proliferating" = "CD8 T",
  "CD8 TCM" = "CD8 T", "CD8 TEM" = "CD8 T",
  "MAIT" = "CD8 T", "dnT" = "CD8 T", "gdT" = "CD8 T",
  "NK" = "NK", "NK Proliferating" = "NK", "NK_CD56bright" = "NK",
  "B intermediate" = "B cell", "B memory" = "B cell", "B naive" = "B cell",
  "Plasmablast" = "Plasma"
)

# Immune cells get labels from Azimuth, non-immune keep compartment name
immune <- subset(merged, compartment %in% c("Myeloid", "T/NK", "B cell", "Plasma"))
immune$cellchat_label <- unname(label_map[immune$azimuth_l2])

non_immune <- subset(merged, compartment %in% c("Epithelial", "Mesothelial"))
non_immune$cellchat_label <- non_immune$compartment

obj <- merge(immune, non_immune)
obj <- subset(obj, !is.na(cellchat_label))

table(obj$cellchat_label)

rm(immune, non_immune, merged)
gc()
```

## CellChat Inference

Running CellChat with triMean -- stricter than truncatedMean, so fewer false positives but might miss some weaker signals.

```{r cellchat_inference, warning=FALSE, message=FALSE}

##############################
###   CELLCHAT INFERENCE   ###
##############################

# triMean is more conservative, which seems appropriate for an exploratory analysis
# could try truncatedMean later to see if we're missing anything
obj <- JoinLayers(obj)
cellchat <- createCellChat(obj, group.by = "cellchat_label")

CellChatDB <- CellChatDB.human
cellchat@DB <- CellChatDB

cellchat <- subsetData(cellchat)
cellchat <- identifyOverExpressedGenes(cellchat)
cellchat <- identifyOverExpressedInteractions(cellchat)
cellchat <- computeCommunProb(cellchat, type = "triMean")
cellchat <- filterCommunication(cellchat, min.cells = 10)
cellchat <- computeCommunProbPathway(cellchat)
cellchat <- aggregateNet(cellchat)
cellchat <- netAnalysis_computeCentrality(cellchat)

saveRDS(cellchat, "data_processed/cellchat_object.rds")

rm(obj)
gc()
```

## Communication Overview

```{r comm_overview, warning=FALSE, message=FALSE, fig.width=10, fig.height=5}

##############################
###   COMMUNICATION        ###
###   OVERVIEW             ###
##############################

par(mfrow = c(1, 2))
netVisual_circle(cellchat@net$count, vertex.weight = table(cellchat@idents),
                 vertex.label.cex = 0.7, edge.width.max = 10)
title("Number of interactions")
netVisual_circle(cellchat@net$weight, vertex.weight = table(cellchat@idents),
                 vertex.label.cex = 0.7, edge.width.max = 10)
title("Interaction strength")
```

CD14 monocytes are the most connected cell type here -- thickest edges both for number and strength. Makes sense given they're the biggest myeloid population and we already saw them skewing M2 in Part 1.

## Signaling Pathway Ranking

Looking at all significant pathways ranked by information flow before picking out the immunosuppressive ones.

```{r pathway_ranking, warning=FALSE, message=FALSE, fig.width=10, fig.height=6}

##############################
###   PATHWAY RANKING      ###
##############################

# rankNet gives a nice overview of what's actually active
gg <- rankNet(cellchat, mode = "single", stacked = TRUE, do.stat = TRUE)
gg
ggsave("figures/cellchat_pathway_ranking.png", gg, width = 10, height = 6)
```

```{r active_pathways, warning=FALSE, message=FALSE}

# what pathways actually made it through
cat("Total active pathways:", length(cellchat@netP$pathways), "\n")
cat(paste(cellchat@netP$pathways, collapse = ", "), "\n")
```

## Immunosuppressive Pathway Networks

Focusing on six pathways tied to macrophage-mediated immunosuppression: MIF, SPP1, GALECTIN, COMPLEMENT, CCL, and FN1. FN1 is included because it's one of the M2TS signature genes from Sullivan et al.

```{r immuno_networks, warning=FALSE, message=FALSE, fig.width=14, fig.height=10}

##############################
###   IMMUNOSUPPRESSIVE    ###
###   PATHWAYS             ###
##############################

immuno_paths <- c("MIF", "SPP1", "GALECTIN", "COMPLEMENT", "CCL", "FN1")

# not all of these necessarily reach significance in every run
active_paths <- cellchat@netP$pathways
immuno_paths <- immuno_paths[immuno_paths %in% active_paths]
cat("Active immunosuppressive pathways:", paste(immuno_paths, collapse = ", "), "\n")

nr <- ceiling(length(immuno_paths) / 3)
par(mfrow = c(nr, 3))
for (p in immuno_paths) {
  netVisual_aggregate(cellchat, signaling = p, layout = "circle",
                      vertex.label.cex = 0.6, edge.width.max = 8)
  title(p)
}

png("figures/cellchat_immunosuppressive_networks.png", width = 14, height = 10, units = "in", res = 300)
par(mfrow = c(nr, 3))
for (p in immuno_paths) {
  netVisual_aggregate(cellchat, signaling = p, layout = "circle",
                      vertex.label.cex = 0.6, edge.width.max = 8)
  title(p)
}
dev.off()
```

A few things jump out from the circle plots. MIF signaling comes mostly from mesothelial cells -- they're the dominant sender there, with epithelial contributing some but less. SPP1 and GALECTIN are monocyte-driven, targeting T cells and DCs. FN1 from CD14 monocytes goes out to basically everything, which is interesting because it connects Sullivan's prognostic signature to actual intercellular communication.

## Sender-Receiver Heatmap

```{r sender_receiver, warning=FALSE, message=FALSE, fig.width=12, fig.height=6}

##############################
###   SENDER-RECEIVER      ###
###   HEATMAP              ###
##############################

netAnalysis_signalingRole_heatmap(cellchat, signaling = immuno_paths, width = 10, height = 6)
```

The heatmap confirms the pattern -- CD14/CD16 monocytes light up as senders for SPP1, GALECTIN, and FN1, while mesothelial cells are the main MIF and COMPLEMENT source. So you've got two separate compartments (myeloid and stromal) both pushing immunosuppression through different pathways. Whether that's coordinated or just convergent isn't clear from this data alone.

## Ligand-Receptor Interactions

Drilling into specific L-R pairs from myeloid and epithelial sources targeting immune effectors.

```{r bubble_plot, warning=FALSE, message=FALSE, fig.width=12, fig.height=8}

##############################
###   LIGAND-RECEPTOR      ###
###   BUBBLE PLOT          ###
##############################

# sources: myeloid + epithelial; targets: lymphocytes + DCs
p <- netVisual_bubble(cellchat,
  sources.use = c("CD14 Mono", "CD16 Mono", "Epithelial"),
  targets.use = c("CD4 T", "CD8 T", "NK", "cDC"),
  signaling = immuno_paths,
  remove.isolate = TRUE)
p
ggsave("figures/cellchat_bubble_immunosuppressive.png", p, width = 12, height = 8)
```

The bubble plot shows a few strong axes. MIF->CD74 from epithelial cells to cDCs has high probability -- potentially dampening antigen presentation. GALECTIN signaling has multiple L-R pairs active (LGALS9-HAVCR2 is there but it's not the strongest one -- the galectin-CD44 and galectin-PTPRK pairs are comparable or bigger). FN1->CD44 from monocytes is prominent, tying the M2 signature gene to a functional signaling output.

## Top Interactions by Probability

```{r top_interactions, warning=FALSE, message=FALSE}

##############################
###   TOP INTERACTIONS     ###
##############################

# TODO: might be worth looking at target-side only (just T cells) to see what
# they're receiving from all sources

df <- subsetCommunication(cellchat, signaling = immuno_paths)
write.csv(df, "tables/cellchat_immunosuppressive_interactions.csv", row.names = FALSE)
cat(nrow(df), "interactions exported\n")
head(df[order(-df$prob), ], 15)
```

FN1->CD44 from monocytes and complement signaling (C3-related) from mesothelial cells dominate the top of the list. MIF from mesothelial cells to monocytes and cDCs is up there too. The overall picture is that the peritoneal stroma (mesothelial cells mainly) is feeding into myeloid-driven suppression -- mesothelial cells recruit and activate monocytes via MIF and complement, and then monocytes do the heavy lifting of suppressing T cells through galectin and SPP1. Not sure if that's a general ascites thing or specific to gastric cancer peritoneal metastasis.
